from telegram import Update, ParseMode, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext, CallbackQueryHandler
import requests
import io
from PIL import Image

BOT_TOKEN = "7443794380:AAHpr7rEM5qkVxVRhOzrfPfES2UU2UU6omg"
OWNER_ID = 6217275870 # Replace with the actual owner ID
allowed_groups = []

def fetch_player_info(uid: str, region: str):
    url = f'https://www.public.freefireinfo.site/api/info/{region}/{uid}?key=Ryz'
    try:
        response = requests.get(url)
        if response.status_code in [200, 500]:
            return response.json()
        else:
            print(f"Failed to fetch player information. Status code: {response.status_code}")
            return None
    except requests.exceptions.RequestException as e:
        print(f"Error fetching data: {e}")
        return None

def format_section(title: str, content: dict) -> str:
    section = f"\nâ”Œ {title}\n"
    for key, value in content.items():
        section += f"â”œâ”€ {key}: {value}\n"
    return section[:-1]

def get_player_info(data: dict, language: str) -> str:
    if language == "ar":
        return format_section_ar(data)
    elif language == "ru":
        return format_section_ru(data)
    else:
        return format_section_en(data)

def format_section_ar(data: dict) -> str:
    return f"""
ðŸ‘¤ **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨**
- **Ø§Ù„Ø§Ø³Ù…**: {data.get("Account Name", "N/A")}
- **Ø§Ù„Ù…Ø¹Ø±Ù**: {data.get("Account UID", "N/A")}
- **Ø§Ù„Ù…Ø³ØªÙˆÙ‰**: {data.get("Account Level", "N/A")} (Exp: {data.get("Account XP", "N/A")})
- **Ø§Ù„Ù…Ù†Ø·Ù‚Ø©**: {data.get("Account Region", "N/A")}
- **Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª**: {data.get("Account Likes", "N/A")}
- **ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ø±Ù**: {data.get("Account Honor Score", "N/A")}
- **Ø´Ø¹Ø§Ø± Ø¥ÙŠÙÙˆ**: {data.get("Account Evo Access Badge", "N/A")}
- **Ø§Ù„Ù„Ù‚Ø¨**: {data.get("Equipped Title", "N/A")}
- **Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©**: {data.get("Account Signature", "N/A")}

ðŸŽ® **Ù†Ø´Ø§Ø· Ø§Ù„Ø­Ø³Ø§Ø¨**
- **Ø§Ù„Ù…Ø±ÙˆØ±**: {data.get("Account Booyah Pass", "N/A")}
- **Ù…Ø³ØªÙˆÙ‰ Booyah pass**: {data.get("Account Booyah Pass Badges", "N/A")}
- **ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¨Ø§ØªÙ„ Ø±ÙˆÙŠØ§Ù„**: {data.get("BR Rank", "N/A")} ({data.get("BR Rank Points", "N/A")})
- **ØªÙ‚ÙŠÙŠÙ… ÙƒÙ„Ø§Ø´ Ø³ÙƒÙˆØ§Ø¯**: {data.get("CS Rank Points", "N/A")}
- **ØªØ§Ø±ÙŠØ® Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨**: {data.get("Account Create Time (GMT 0530)", "N/A")}
- **Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„**: {data.get("Account Last Login (GMT 0530)", "N/A")}

ðŸ‘• **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²ÙŠ**
- **Ù…Ø¹Ø±Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø²ÙŠØ©**: {data.get("Account Avatar Image", "N/A").split("/")[-1]}
- **Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø¹Ø§Ø±**: {data.get("Account Banner Image", "N/A").split("/")[-1]}
- **Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ù‡Ø²Ø©**: {", ".join(map(str, data.get("Equipped Items", {}).get("Equipped Skills", [])))}
- **Ù…Ø¹Ø±Ù Ø³Ù„Ø§Ø­ Ø§Ù„Ù…Ø®ØªØ§Ø±**: {data.get("Equipped Items", {}).get("External Items", [{}])[0].get("Item ID", "Not Found")}

ðŸ¾ **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø£Ù„ÙŠÙ**
- **Ù…Ø¬Ù‡Ø²ØŸ**: {"Ù†Ø¹Ù…" if data.get("Equipped Pet Information", {}).get("Equipped?", True) else "Ù„Ø§"}
- **Ø§Ø³Ù… Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø£Ù„ÙŠÙ**: {data.get("Equipped Pet Information", {}).get("Pet Name", "N/A")}
- **Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø£Ù„ÙŠÙ**: {data.get("Equipped Pet Information", {}).get("Pet Type", "N/A")}
- **Ø®Ø¨Ø±Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø£Ù„ÙŠÙ**: {data.get("Equipped Pet Information", {}).get("Pet XP", "N/A")}
- **Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø£Ù„ÙŠÙ**: {data.get("Equipped Pet Information", {}).get("Pet Level", "N/A")}

ðŸ›¡ï¸ **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù‚Ø§Ø¨Ø©**
- **Ø§Ø³Ù… Ø§Ù„Ù†Ù‚Ø§Ø¨Ø©**: {data.get("Guild Information", {}).get("Guild Name", "N/A")}
- **Ù…Ø¹Ø±Ù Ø§Ù„Ù†Ù‚Ø§Ø¨Ø©**: {data.get("Guild Information", {}).get("Guild ID", "N/A")}
- **Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ù‚Ø§Ø¨Ø©**: {data.get("Guild Information", {}).get("Guild Level", "N/A")}
- **Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡**: {data.get("Guild Information", {}).get("Guild Current Members", "N/A")}
- **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ø¯**:
  - **Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ø¯**: {data.get("Guild Leader Information", {}).get("Leader Name", "N/A")}
  - **Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ø§Ø¦Ø¯**: {data.get("Guild Leader Information", {}).get("Leader UID", "N/A")}
  - **Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¦Ø¯**: {data.get("Guild Leader Information", {}).get("Leader Level", "N/A")} (Exp: {data.get("Guild Leader Information", {}).get("Leader XP", "N/A")})
  - **ØªØ§Ø±ÙŠØ® Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ø¯**: {data.get("Guild Leader Information", {}).get("Leader Ac Created Time (GMT 0530)", "N/A")}
  - **Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù‚Ø§Ø¦Ø¯**: {data.get("Guild Leader Information", {}).get("Leader Last Login Time (GMT 0530)", "N/A")}
  - **Ù„Ù‚Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ø¯**: {data.get("Guild Leader Information", {}).get("Leader Title", "N/A")}
  - **Ø´Ø§Ø±Ø§Øª BP Ø§Ù„Ù‚Ø§Ø¦Ø¯**: {data.get("Guild Leader Information", {}).get("Leader BP Badges", "N/A")}
  - **ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¨Ø§ØªÙ„ Ø±ÙˆÙŠØ§Ù„ Ù„Ù„Ù‚Ø§Ø¦Ø¯**: {data.get("Guild Leader Information", {}).get("Leader BR Points", "N/A")}
  - **ØªÙ‚ÙŠÙŠÙ… ÙƒÙ„Ø§Ø´ Ø³ÙƒÙˆØ§Ø¯ Ù„Ù„Ù‚Ø§Ø¦Ø¯**: {data.get("Guild Leader Information", {}).get("Leader CS Points", "N/A")}

ðŸ—ºï¸ **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒØ±Ø§ÙØªÙ„Ø§Ù†Ø¯**
- **Ø±Ù…Ø² Ø§Ù„Ø®Ø±ÙŠØ·Ø©**: {data.get("Public Craftland Maps", {}).get("Map Codes", "Not Found")}
"""

def format_section_ru(data: dict) -> str:
    return f"""
ðŸ‘¤ **Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ðµ**
- **Ð˜Ð¼Ñ**: {data.get("Account Name", "N/A")}
- **UID**: {data.get("Account UID", "N/A")}
- **Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ**: {data.get("Account Level", "N/A")} (Exp: {data.get("Account XP", "N/A")})
- **Ð ÐµÐ³Ð¸Ð¾Ð½**: {data.get("Account Region", "N/A")}
- **Ð›Ð°Ð¹ÐºÐ¸**: {data.get("Account Likes", "N/A")}
- **Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³ Ð´Ð¾Ð²ÐµÑ€Ð¸Ñ**: {data.get("Account Honor Score", "N/A")}
- **Ð—Ð½Ð°Ñ‡Ð¾Ðº Ð­Ð²Ð¾**: {data.get("Account Evo Access Badge", "N/A")}
- **Ð¢Ð¸Ñ‚ÑƒÐ»**: {data.get("Equipped Title", "N/A")}
- **Ð‘Ð¸Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ**: {data.get("Account Signature", "N/A")}

ðŸŽ® **ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°**
- **Ð‘Ð¾ÐµÐ²Ð¾Ð¹ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐº**: {data.get("Account Booyah Pass", "N/A")}
- **Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ Ð±Ð¾ÐµÐ²Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°**: {data.get("Account Booyah Pass Badges", "N/A")}
- **Ð Ð°Ð½Ð³ BR**: {data.get("BR Rank", "N/A")} ({data.get("BR Rank Points", "N/A")})
- **Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³ CS**: {data.get("CS Rank Points", "N/A")}
- **ÐÐºÐºÐ°ÑƒÐ½Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½**: {data.get("Account Create Time (GMT 0530)", "N/A")}
- **ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð²Ñ…Ð¾Ð´**: {data.get("Account Last Login (GMT 0530)", "N/A")}

ðŸ‘• **Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð½Ð°Ñ€ÑÐ´Ðµ**
- **ID Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°**: {data.get("Account Avatar Image", "N/A").split("/")[-1]}
- **ID Ð±Ð°Ð½Ð½ÐµÑ€Ð°**: {data.get("Account Banner Image", "N/A").split("/")[-1]}
- **ÐžÑÐ½Ð°Ñ‰ÐµÐ½Ð½Ñ‹Ðµ Ð½Ð°Ð²Ñ‹ÐºÐ¸**: {", ".join(map(str, data.get("Equipped Items", {}).get("Equipped Skills", [])))}
- **ID Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¾Ñ€ÑƒÐ¶Ð¸Ñ**: {data.get("Equipped Items", {}).get("External Items", [{}])[0].get("Item ID", "Not Found")}

ðŸ¾ **Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¸Ñ‚Ð¾Ð¼Ñ†Ðµ**
- **ÐžÑÐ½Ð°Ñ‰ÐµÐ½?**: {"Ð”Ð°" if data.get("Equipped Pet Information", {}).get("Equipped?", True) else "ÐÐµÑ‚"}
- **Ð˜Ð¼Ñ Ð¿Ð¸Ñ‚Ð¾Ð¼Ñ†Ð°**: {data.get("Equipped Pet Information", {}).get("Pet Name", "N/A")}
- **Ð¢Ð¸Ð¿ Ð¿Ð¸Ñ‚Ð¾Ð¼Ñ†Ð°**: {data.get("Equipped Pet Information", {}).get("Pet Type", "N/A")}
- **ÐžÐ¿Ñ‹Ñ‚ Ð¿Ð¸Ñ‚Ð¾Ð¼Ñ†Ð°**: {data.get("Equipped Pet Information", {}).get("Pet XP", "N/A")}
- **Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ Ð¿Ð¸Ñ‚Ð¾Ð¼Ñ†Ð°**: {data.get("Equipped Pet Information", {}).get("Pet Level", "N/A")}

ðŸ›¡ï¸ **Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ð¸Ð»ÑŒÐ´Ð¸Ð¸**
- **ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ð¸Ð»ÑŒÐ´Ð¸Ð¸**: {data.get("Guild Information", {}).get("Guild Name", "N/A")}
- **ID Ð³Ð¸Ð»ÑŒÐ´Ð¸Ð¸**: {data.get("Guild Information", {}).get("Guild ID", "N/A")}
- **Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ Ð³Ð¸Ð»ÑŒÐ´Ð¸Ð¸**: {data.get("Guild Information", {}).get("Guild Level", "N/A")}
- **Ð§Ð»ÐµÐ½Ñ‹ Ð³Ð¸Ð»ÑŒÐ´Ð¸Ð¸**: {data.get("Guild Information", {}).get("Guild Current Members", "N/A")}
- **Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð»Ð¸Ð´ÐµÑ€Ðµ**:
  - **Ð˜Ð¼Ñ Ð»Ð¸Ð´ÐµÑ€Ð°**: {data.get("Guild Leader Information", {}).get("Leader Name", "N/A")}
  - **UID Ð»Ð¸Ð´ÐµÑ€Ð°**: {data.get("Guild Leader Information", {}).get("Leader UID", "N/A")}
  - **Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ Ð»Ð¸Ð´ÐµÑ€Ð°**: {data.get("Guild Leader Information", {}).get("Leader Level", "N/A")} (Exp: {data.get("Guild Leader Information", {}).get("Leader XP", "N/A")})
  - **ÐÐºÐºÐ°ÑƒÐ½Ñ‚ Ð»Ð¸Ð´ÐµÑ€Ð° ÑÐ¾Ð·Ð´Ð°Ð½**: {data.get("Guild Leader Information", {}).get("Leader Ac Created Time (GMT 0530)", "N/A")}
  - **ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð²Ñ…Ð¾Ð´ Ð»Ð¸Ð´ÐµÑ€Ð°**: {data.get("Guild Leader Information", {}).get("Leader Last Login Time (GMT 0530)", "N/A")}
  - **Ð¢Ð¸Ñ‚ÑƒÐ» Ð»Ð¸Ð´ÐµÑ€Ð°**: {data.get("Guild Leader Information", {}).get("Leader Title", "N/A")}
  - **Ð—Ð½Ð°Ñ‡ÐºÐ¸ BP Ð»Ð¸Ð´ÐµÑ€Ð°**: {data.get("Guild Leader Information", {}).get("Leader BP Badges", "N/A")}
  - **Ð Ð°Ð½Ð³ BR Ð»Ð¸Ð´ÐµÑ€Ð°**: {data.get("Guild Leader Information", {}).get("Leader BR Points", "N/A")}
  - **Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³ CS Ð»Ð¸Ð´ÐµÑ€Ð°**: {data.get("Guild Leader Information", {}).get("Leader CS Points", "N/A")}

ðŸ—ºï¸ **Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÐšÑ€Ð°Ñ„Ñ‚Ð»Ð°Ð½Ð´Ðµ**
- **ÐšÐ¾Ð´ ÐºÐ°Ñ€Ñ‚Ñ‹**: {data.get("Public Craftland Maps", {}).get("Map Codes", "Not Found")}
"""

def format_section_en(data: dict) -> str:
    return f"""
ðŸ‘¤ **Account Info**
- **Name**: {data.get("Account Name", "N/A")}
- **UID**: {data.get("Account UID", "N/A")}
- **Level**: {data.get("Account Level", "N/A")} (Exp: {data.get("Account XP", "N/A")})
- **Region**: {data.get("Account Region", "N/A")}
- **Likes**: {data.get("Account Likes", "N/A")}
- **Honor Score**: {data.get("Account Honor Score", "N/A")}
- **Evo Access Badge**: {data.get("Account Evo Access Badge", "N/A")}
- **Title**: {data.get("Equipped Title", "N/A")}
- **Signature**: {data.get("Account Signature", "N/A")}

ðŸŽ® **Account Activity**
- **Booyah Pass**: {data.get("Account Booyah Pass", "N/A")}
- **Booyah Pass Level**: {data.get("Account Booyah Pass Badges", "N/A")}
- **BR Rank**: {data.get("BR Rank", "N/A")} ({data.get("BR Rank Points", "N/A")})
- **CS Rank Points**: {data.get("CS Rank Points", "N/A")}
- **Account Created**: {data.get("Account Create Time (GMT 0530)", "N/A")}
- **Last Login**: {data.get("Account Last Login (GMT 0530)", "N/A")}

ðŸ‘• **Outfit Info**
- **Avatar ID**: {data.get("Account Avatar Image", "N/A").split("/")[-1]}
- **Banner ID**: {data.get("Account Banner Image", "N/A").split("/")[-1]}
- **Equipped Skills**: {", ".join(map(str, data.get("Equipped Items", {}).get("Equipped Skills", [])))}
- **Equipped Weapon Skin ID**: {data.get("Equipped Items", {}).get("External Items", [{}])[0].get("Item ID", "Not Found")}

ðŸ¾ **Pet Info**
- **Equipped?**: {"Yes" if data.get("Equipped Pet Information", {}).get("Equipped?", True) else "No"}
- **Pet Name**: {data.get("Equipped Pet Information", {}).get("Pet Name", "N/A")}
- **Pet Type**: {data.get("Equipped Pet Information", {}).get("Pet Type", "N/A")}
- **Pet XP**: {data.get("Equipped Pet Information", {}).get("Pet XP", "N/A")}
- **Pet Level**: {data.get("Equipped Pet Information", {}).get("Pet Level", "N/A")}

ðŸ›¡ï¸ **Guild Info**
- **Guild Name**: {data.get("Guild Information", {}).get("Guild Name", "N/A")}
- **Guild ID**: {data.get("Guild Information", {}).get("Guild ID", "N/A")}
- **Guild Level**: {data.get("Guild Information", {}).get("Guild Level", "N/A")}
- **Guild Members**: {data.get("Guild Information", {}).get("Guild Current Members", "N/A")}
- **Leader Info**:
  - **Leader Name**: {data.get("Guild Leader Information", {}).get("Leader Name", "N/A")}
  - **Leader UID**: {data.get("Guild Leader Information", {}).get("Leader UID", "N/A")}
  - **Leader Level**: {data.get("Guild Leader Information", {}).get("Leader Level", "N/A")} (Exp: {data.get("Guild Leader Information", {}).get("Leader XP", "N/A")})
  - **Leader Account Created**: {data.get("Guild Leader Information", {}).get("Leader Ac Created Time (GMT 0530)", "N/A")}
  - **Leader Last Login**: {data.get("Guild Leader Information", {}).get("Leader Last Login Time (GMT 0530)", "N/A")}
  - **Leader Title**: {data.get("Guild Leader Information", {}).get("Leader Title", "N/A")}
  - **Leader BP Badges**: {data.get("Guild Leader Information", {}).get("Leader BP Badges", "N/A")}
  - **Leader BR Points**: {data.get("Guild Leader Information", {}).get("Leader BR Points", "N/A")}
  - **Leader CS Points**: {data.get("Guild Leader Information", {}).get("Leader CS Points", "N/A")}

ðŸ—ºï¸ **Craftland Info**
- **Map Code**: {data.get("Public Craftland Maps", {}).get("Map Codes", "Not Found")}
"""

def create_combined_image(avatar_url: str, banner_url: str) -> Image.Image:
    try:
        response_banner = requests.get(banner_url)
        response_avatar = requests.get(avatar_url)
        banner_image = Image.open(io.BytesIO(response_banner.content))
        avatar_image = Image.open(io.BytesIO(response_avatar.content))

        avatar_image = avatar_image.resize((57, 57))
        position = (banner_image.height - avatar_image.height, 2)
        combined_image = banner_image.copy()
        combined_image.paste(avatar_image, position, avatar_image.convert("RGBA"))

        return combined_image

    except Exception as e:
        print(f"Failed to create combined image: {e}")
        return None

def create_clothes_image(clothes_urls: list) -> Image.Image:
    try:
        max_width = 57
        max_height = 57
        num_clothes = len(clothes_urls)
        max_cols = 4
        num_rows = (num_clothes + max_cols - 1) // max_cols
        combined_clothes_image = Image.new('RGBA', (max_width * max_cols, max_height * num_rows))

        for idx, url in enumerate(clothes_urls):
            response_clothes = requests.get(url)
            clothes_image = Image.open(io.BytesIO(response_clothes.content))
            clothes_image = clothes_image.resize((max_width, max_height))
            col = idx % max_cols
            row = idx // max_cols
            x = col * max_width
            y = row * max_height
            combined_clothes_image.paste(clothes_image, (x, y))

        return combined_clothes_image

    except Exception as e:
        print(f"Failed to create combined clothes image: {e}")
        return None

def handle_message(update: Update, context: CallbackContext) -> None:
    chat_id = update.message.chat_id
    if chat_id not in allowed_groups:
        update.message.reply_text("This bot is not allowed to operate in this group.")
        return
    
    message_text = update.message.text.split()
    if len(message_text) != 2:
        return
    region, uid = message_text
    if region not in ['sg', 'ind', 'br']:
        return
    
    context.user_data['region'] = region
    context.user_data['uid'] = uid

    keyboard = [
        [
            InlineKeyboardButton("English", callback_data='en'),
            InlineKeyboardButton("Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", callback_data='ar'),
            InlineKeyboardButton("Ð ÑƒÑÑÐºÐ¸Ð¹", callback_data='ru')
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    update.message.reply_text('Please choose a language / ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© / ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ·Ñ‹Ðº:', reply_markup=reply_markup)

def choose_language(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    query.answer()
    language = query.data

    region = context.user_data.get('region')
    uid = context.user_data.get('uid')
    data = fetch_player_info(uid, region)

    if data:
        avatar_url = data.get("Account Avatar Image")
        banner_url = data.get("Account Banner Image")
        clothes_urls = data.get("Equipped Items", {}).get("profile", {}).get("Clothes", [])
        player_info = get_player_info(data, language)

        if avatar_url and banner_url:
            combined_image = create_combined_image(avatar_url, banner_url)
            if combined_image:
                combined_webp_io = io.BytesIO()
                combined_image.save(combined_webp_io, format='webp')
                combined_webp_io.seek(0)
                query.message.reply_sticker(combined_webp_io)

        if clothes_urls:
            combined_clothes_image = create_clothes_image(clothes_urls)
            if combined_clothes_image:
                clothes_io = io.BytesIO()
                combined_clothes_image.save(clothes_io, format='PNG')
                clothes_io.seek(0)
                query.message.reply_photo(clothes_io)

        query.message.reply_text(player_info, parse_mode=ParseMode.MARKDOWN)
        query.message.edit_reply_markup(reply_markup=None)
    else:
        query.message.reply_text("Failed to fetch player information. Please check the UID and region.")
        query.message.edit_reply_markup(reply_markup=None)

def add_group(update: Update, context: CallbackContext) -> None:
    if update.message.from_user.id != OWNER_ID:
        update.message.reply_text("You are not authorized to use this command.")
        return

    if len(context.args) != 1:
        update.message.reply_text("Usage: /add <group_id>")
        return
    
    group_id = int(context.args[0])
    if group_id not in allowed_groups:
        allowed_groups.append(group_id)
        update.message.reply_text(f"Group {group_id} has been added to the allowed list.")
    else:
        update.message.reply_text(f"Group {group_id} is already in the allowed list.")

def start(update: Update, context: CallbackContext) -> None:
    update.message.reply_text('HI ON BOT INFO DEV BY FOX AND SATURNE & TAKE PLEASE SEND (regoin and uid)')
def main() -> None:
    updater = Updater(BOT_TOKEN, use_context=True)
    dispatcher = updater.dispatcher

    dispatcher.add_handler(CommandHandler("start", start))
    dispatcher.add_handler(CommandHandler("add", add_group))
    dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_message))
    dispatcher.add_handler(CallbackQueryHandler(choose_language))

    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
